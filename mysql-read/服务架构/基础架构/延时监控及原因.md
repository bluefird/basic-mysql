## 主从延时监控及原因     

主库做了修改操作,从库比较长时间才能追上.

### 1外在因素

- 网络 
- 主从硬件差异较大
- 版本差异
- 参数因素

### 2 主库

(1) 二进制日志写入不及时

```mysql
[rep]>select @@sync_binlog;
```

(2) CR的主从复制中,binlog_dump线程,事件为单元,串行传送二进制日志(5.6 5.5)

主库并发事务量大,主库可以并行,传送时是串行

主库发生了大事务,由于是串行传送,会产生阻塞后续的事务.
解决方案:

- 5.6 开始,开启GTID,实现了GC(group commit)机制,可以并行传输日志给从库IO
- 5.7 开始,不开启GTID,会自动维护匿名的GTID,也能实现GC,我们建议还是认为开启GTID
- 大事务拆成多个小事务,可以有效的减少主从延时.

### 3  从库

SQL线程导致的主从延时
在CR复制情况下: 从库默认情况下只有一个SQL,只能串行回放事务SQL

- 主库如果并发事务量较大,从库只能串行回放
- 主库发生了大事务,会阻塞后续的所有的事务的运行

解决方案:
5.6 版本开启GTID之后,加入了SQL多线程的特性,但是只能针对不同库(database)下的事务进行并发回放.
5.7 版本开始GTID之后,在SQL方面,提供了基于逻辑时钟(logical_clock),binlog加入了seq_no机制,
真正实现了基于事务级别的并发回放,这种技术我们把它称之为MTS(enhanced multi-threaded slave).
 大事务拆成多个小事务,可以有效的减少主从延时.
[https://dev.mysql.com/worklog/task/?id=6314]

### 7. 小结

- 主从复制原理
- 主从复制故障
- 主从延时：group commit    MTS  